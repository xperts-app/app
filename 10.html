<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Exam Result - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary-blue:#0066ff;--background-color:#f0f4f9;--text-dark:#1d2c3c;--text-light:#5a6b7d;--border-color:#dbe2ea;--success-green:#28a745;}
        body{font-family:'Poppins',sans-serif;background-color:var(--background-color);margin:0;padding-top:5vh}
        .main-container{max-width:600px;margin:auto;padding:20px;text-align:center}
        .illustration{width:150px;height:150px;margin:0 auto 20px auto}
        h2{font-weight:600;font-size:28px;color:var(--text-dark);margin-bottom:12px}
        p.subtitle{color:var(--text-light);font-size:16px;margin-bottom:30px}
        .form-section{margin-bottom:25px;text-align:left}
        label{display:block;margin-bottom:8px;font-weight:500;font-size:14px;color:var(--text-dark)}
        select, input{width:100%;padding:15px;border:1px solid var(--border-color);border-radius:12px;font-size:16px;background-color:#fff;font-family:'Poppins',sans-serif;box-sizing:border-box}
        select:disabled, input:disabled{background-color:#f8f9fa}
        #result-details{display:none;margin-top:25px;border-top:1px solid var(--border-color);padding-top:25px}
        .marks-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        .btn-primary{background-color:var(--success-green);color:#fff;border:none;padding:16px 0;border-radius:12px;font-size:18px;font-weight:600;width:100%;cursor:pointer;transition:all .3s;margin-top:10px}
        .btn-primary:disabled{background-color:#a3d9b1;cursor:not-allowed}
        #message-area{text-align:center;font-weight:500;margin-top:20px;min-height:1.2em}
        #message-area.success{color:var(--success-green)}
        #message-area.error{color:#dc3545}
    </style>
</head>
<body>
    <div class="main-container">
        <svg class="illustration" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 21H15" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 21V3" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 11L15 8L12 5" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 3H19C20.1046 3 21 3.89543 21 5V19C21 20.1046 20.1046 21 19 21H12" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H12" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>

        <h2>Add Exam Result</h2>
        <p class="subtitle">Select a class and student, then enter their exam result details.</p>
        
        <div class="form-section">
            <label for="class-select">Step 1: Select a Class</label>
            <select id="class-select">
                <option value="">-- Choose a class --</option>
                <option value="6">6th</option><option value="7">7th</option><option value="8">8th</option>
                <option value="9">9th</option><option value="10">10th</option><option value="11">11th</option><option value="12">12th</option>
            </select>
        </div>
        
        <div class="form-section">
            <label for="student-select">Step 2: Select a Student</label>
            <select id="student-select" disabled>
                <option value="">-- Waiting for class selection --</option>
            </select>
        </div>

        <div id="result-details">
            <div class="form-section">
                <label for="exam-name">Step 3: Exam Name</label>
                <input type="text" id="exam-name" placeholder="e.g., Mid-Term Physics Test">
            </div>
            <div class="form-section marks-grid">
                <div>
                    <label for="marks-obtained">Marks Obtained</label>
                    <input type="number" id="marks-obtained" placeholder="e.g., 85">
                </div>
                <div>
                    <label for="total-marks">Total Marks</label>
                    <input type="number" id="total-marks" placeholder="e.g., 100">
                </div>
            </div>
            <button class="btn-primary" id="save-result-btn">Save Result</button>
        </div>

        <p id="message-area"></p>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyD-ers6CRuH8bCFomXJHuLxPWff-Xa4ZVk", authDomain: "xperts-data.firebaseapp.com", projectId: "xperts-data", storageBucket: "xperts-data.firebasestorage.app", messagingSenderId: "934675149024", appId: "1:934675149024:web:23486a5f38f65f103ce085" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const classSelect = document.getElementById('class-select');
        const studentSelect = document.getElementById('student-select');
        const resultDetailsDiv = document.getElementById('result-details');
        const saveBtn = document.getElementById('save-result-btn');
        const messageArea = document.getElementById('message-area');

        classSelect.addEventListener('change', async (e) => {
            const selectedClassStr = e.target.value;
            studentSelect.innerHTML = '<option value="">Loading students...</option>';
            studentSelect.disabled = true;
            resultDetailsDiv.style.display = 'none';

            if (!selectedClassStr) { studentSelect.innerHTML = '<option value="">-- Waiting for class selection --</option>'; return; }

            try {
                const selectedClassNum = parseInt(selectedClassStr, 10);
                const queryStr = db.collection('users').where('class', '==', selectedClassStr).where('role', '==', 'Student').get();
                const queryNum = db.collection('users').where('class', '==', selectedClassNum).where('role', '==', 'Student').get();
                const [stringResults, numberResults] = await Promise.all([queryStr, queryNum]);

                const studentsMap = new Map();
                stringResults.forEach(doc => studentsMap.set(doc.id, { id: doc.id, name: doc.data().fullName }));
                numberResults.forEach(doc => studentsMap.set(doc.id, { id: doc.id, name: doc.data().fullName }));
                const students = Array.from(studentsMap.values()).sort((a, b) => a.name.localeCompare(b.name));

                if (students.length === 0) { studentSelect.innerHTML = '<option value="">-- No students found --</option>'; return; }

                studentSelect.innerHTML = '<option value="">-- Select a student --</option>';
                students.forEach(student => { studentSelect.innerHTML += `<option value="${student.id}" data-name="${student.name}">${student.name}</option>`; });
                studentSelect.disabled = false;
            } catch (error) { console.error("Error fetching students:", error); studentSelect.innerHTML = '<option value="">-- Error loading --</option>'; }
        });

        studentSelect.addEventListener('change', () => { if (studentSelect.value) { resultDetailsDiv.style.display = 'block'; } else { resultDetailsDiv.style.display = 'none'; } });

        saveBtn.addEventListener('click', async () => {
            const studentId = studentSelect.value;
            const selectedOption = studentSelect.options[studentSelect.selectedIndex];
            const studentName = selectedOption.dataset.name;
            const examName = document.getElementById('exam-name').value.trim();
            const marksObtained = parseFloat(document.getElementById('marks-obtained').value);
            const totalMarks = parseFloat(document.getElementById('total-marks').value);

            if (!studentId || !examName || isNaN(marksObtained) || isNaN(totalMarks) || totalMarks <= 0) { messageArea.textContent = 'Please fill all fields with valid numbers.'; messageArea.className = 'error'; return; }

            saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; messageArea.textContent = '';
            
            const resultData = { studentId, studentName, class: classSelect.value, examName, marksObtained, totalMarks, dateAdded: firebase.firestore.FieldValue.serverTimestamp() };

            try {
                await db.collection('results').add(resultData);
                messageArea.textContent = 'Result saved successfully!'; messageArea.className = 'success';
                document.getElementById('exam-name').value = ''; document.getElementById('marks-obtained').value = ''; document.getElementById('total-marks').value = '';
                studentSelect.value = ''; resultDetailsDiv.style.display = 'none';
            } catch (error) {
                console.error("Error saving result:", error);
                messageArea.textContent = 'Failed to save result. Please try again.'; messageArea.className = 'error';
            } finally { saveBtn.disabled = false; saveBtn.textContent = 'Save Result'; }
        });
    </script>
</body>
</html>
