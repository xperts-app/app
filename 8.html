<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensors</title>
    <style>
    </style>
</head>
<body class="loading">

    <div class="message-box">
       
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyD-ers6CRuH8bCFomXJHuLxPWff-Xa4ZVk", authDomain: "xperts-data.firebaseapp.com", projectId: "xperts-data", storageBucket: "xperts-data.firebasestorage.app", messagingSenderId: "934675149024", appId: "1:934675149024:web:23486a5f38f65f103ce085" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const bodyEl = document.querySelector('body');
        const mainHeadingEl = document.getElementById('main-heading');
        const subTextEl = document.getElementById('sub-text');

        // This map is expanded to include all possible keys we might generate
        const classUrlMap = {
            '6': 'https://abc.xyz/6', '7': 'https://abc.xyz/7', '8': 'https://abc.xyz/8',
            '9': 'https://abc.xyz/9', '10': 'https://abc.xyz/10',
            // Composite keys for separate class/goal fields
            '11-NEET': 'https://abc.xyz/N11', '11-JEE': 'https://abc.xyz/J11',
            '12-NEET': 'https://abc.xyz/N12', '12-JEE': 'https://abc.xyz/J12',
            // Keys for the combined class field (e.g., "11 NEET")
            '11 NEET': 'https://abc.xyz/N11', '11 JEE': 'https://abc.xyz/J11',
            '12 NEET': 'https://abc.xyz/N12', '12 JEE': 'https://abc.xyz/J12'
        };

        function showMessage(heading, subtext, status = 'loading') {
            mainHeadingEl.textContent = heading;
            subTextEl.textContent = subtext;
            bodyEl.className = status;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const userId = localStorage.getItem('loggedInUserId');
            if (!userId) {
                showMessage('Access Denied', 'You are not logged in. Please log in to continue.', 'error');
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    showMessage('Error', 'Your user profile could not be found.', 'error');
                    return;
                }

                const userData = userDoc.data();
                const { class: userClass, goal: userGoal, role: userRole } = userData;

                if (userRole !== 'Student') {
                    showMessage('Access Denied', 'This page is for students only.', 'error');
                    return;
                }
                if (!userClass) {
                    showMessage('Profile Incomplete', 'Your student profile has no class assigned. Please contact support.', 'error');
                    return;
                }

                // --- ROBUST LOGIC TO DETERMINE THE LOOKUP KEY ---
                let lookupKey = '';

                // Case 1: The class field is combined (e.g., "11 NEET"). This is the most specific.
                if (typeof userClass === 'string' && userClass.includes(' ')) {
                    lookupKey = userClass;
                } 
                // Case 2: The goal is specific (NEET/JEE)
                else if (userGoal === 'NEET' || userGoal === 'JEE') {
                    // Normalize class (e.g., "11th" -> "11")
                    const normalizedClass = userClass.toString().replace('th', '');
                    lookupKey = `${normalizedClass}-${userGoal}`; // Creates "11-NEET"
                } 
                // Case 3: Simple class (e.g., "6", "7th")
                else {
                    // Normalize the class to just a number
                    lookupKey = userClass.toString().replace('th', '');
                }
                // --- END OF ROBUST LOGIC ---

                const redirectUrl = classUrlMap[lookupKey];

                if (!redirectUrl) {
                    showMessage('Configuration Error', `Could not find a valid destination for your profile (Key: "${lookupKey}"). Please contact support.`, 'error');
                    return;
                }

                // Success Case
                showMessage('Ready to Go!', 'Click anywhere on the page to proceed.');
                bodyEl.classList.add('ready');
                bodyEl.addEventListener('click', () => {
                    showMessage('Redirecting...', 'Please wait.');
                    window.location.href = redirectUrl;
                });

            } catch (error) {
                console.error("Error fetching user data:", error);
                showMessage('An Error Occurred', 'We could not fetch your profile. Please try again later.', 'error');
            }
        });
    </script>
</body>
</html>
