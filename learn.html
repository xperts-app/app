<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome - Class Schedules</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; }
        #notification-banner {
            display: none; /* Hidden by default */
            background-color: #28a745;
            color: white;
            padding: 15px;
            position: fixed;
            top: 0;
            width: 100%;
            text-align: center;
            font-size: 18px;
            z-index: 1000;
        }
        #notification-banner a {
            color: #fff;
            font-weight: bold;
            text-decoration: underline;
        }
        #notification-banner .close-btn {
            float: right;
            cursor: pointer;
            font-weight: bold;
            margin-right: 20px;
        }
    </style>
</head>
<body>

    <!-- This banner will be shown if there's a new schedule -->
    <div id="notification-banner">
        <span>A new class schedule has been posted!</span>
        <a href="2.html">View Now</a>
        <span class="close-btn" onclick="dismissNotification()">X</span>
    </div>

    <h1>Welcome to Our Site</h1>
    <p>We will notify you if there are new class schedules.</p>
    <a href="2.html">Go to Live Class Schedule Page</a>

    <!-- We use type="module" to allow import/export -->
    <script type="module">
        // Import the database connection from our init file
        import { db } from './firebase-init.js';
        
        // Import the functions we need from Firestore
        import { collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const notificationBanner = document.getElementById('notification-banner');
        let latestScheduleTimestamp = null;

        async function checkNewSchedule() {
            try {
                // Create a query to get the single most recent document based on createdAt
                const schedulesRef = collection(db, "schedules");
                const q = query(schedulesRef, orderBy("createdAt", "desc"), limit(1));

                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const latestDoc = querySnapshot.docs[0];
                    const latestData = latestDoc.data();
                    
                    // The createdAt field is a Firestore Timestamp object
                    latestScheduleTimestamp = latestData.createdAt.toMillis(); // Convert to milliseconds
                    
                    // Get the timestamp of the last schedule the user saw
                    const lastSeenTimestamp = localStorage.getItem('lastSeenScheduleTimestamp');

                    // If the latest schedule is newer than the one they last saw (or if they've never seen one)
                    if (!lastSeenTimestamp || latestScheduleTimestamp > parseInt(lastSeenTimestamp)) {
                        notificationBanner.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error("Error checking for new schedule: ", error);
            }
        }
        
        // Function to hide the banner and update localStorage
        window.dismissNotification = function() {
            notificationBanner.style.display = 'none';
            // Store the timestamp of the new schedule so the user isn't notified again
            if (latestScheduleTimestamp) {
                localStorage.setItem('lastSeenScheduleTimestamp', latestScheduleTimestamp);
            }
        }

        // Run the check when the page loads
        checkNewSchedule();
    </script>

</body>
</html>
