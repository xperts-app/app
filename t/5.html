<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; }
        .header { background: #E67E22; color: white; padding: 15px 20px; font-size: 20px; font-weight: 500; display: flex; align-items: center; }
        .header .back-arrow { font-size: 24px; margin-right: 15px; cursor: pointer; }
        .container { padding: 20px; }
        h1 { text-align: center; color: #333; }
        .leaderboard-list { list-style: none; padding: 0; }
        .list-item { display: flex; align-items: center; background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .rank { font-size: 20px; font-weight: bold; color: #888; min-width: 50px; text-align: center; }
        .name { flex-grow: 1; font-weight: 500; color: #333; }
        .score { font-size: 18px; font-weight: bold; color: #E67E22; }
        .list-item.gold { border-left: 5px solid #FFD700; }
        .list-item.silver { border-left: 5px solid #C0C0C0; }
        .list-item.bronze { border-left: 5px solid #CD7F32; }
        .list-item.user-highlight { background-color: #e8f4fd; border-left-color: #3498DB; }
        .medal { font-size: 24px; }
        #loading { text-align: center; padding: 50px; font-size: 18px; color: #777; }
    </style>
</head>
<body>

<div class="header">
    <span class="back-arrow" onclick="history.back()">&larr;</span>
    <span id="header-title">Leaderboard</span>
</div>

<div class="container">
    <h1 id="test-name-title"></h1>
    <ul class="leaderboard-list" id="leaderboard-list">
        <!-- Ranks will be populated here -->
    </ul>
    <p id="loading">Loading leaderboard...</p>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDVIgUAmKlJqwvkd9kblaujzIVlSq9_EiM",
      authDomain: "tests-data-with-leaderboard.firebaseapp.com",
      projectId: "tests-data-with-leaderboard",
      storageBucket: "tests-data-with-leaderboard.firebasestorage.app",
      messagingSenderId: "884648979462",
      appId: "1:884648979462:web:446df6ccb02bf73397e787",
      measurementId: "G-701ZP61XZT"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadLeaderboard() {
        const urlParams = new URLSearchParams(window.location.search);
        const testId = urlParams.get('testId');
        const currentUserId = localStorage.getItem('userId');

        if (!testId) {
            document.getElementById('loading').textContent = 'Error: Test ID not found.';
            return;
        }

        try {
            const resultsSnapshot = await db.collection('results')
                .where('testId', '==', testId)
                .orderBy('score', 'desc')
                .get();
            
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            document.getElementById('loading').style.display = 'none';
            
            if (resultsSnapshot.empty) {
                leaderboardList.innerHTML = '<p>No results found for this test yet.</p>';
                return;
            }

            document.getElementById('test-name-title').textContent = resultsSnapshot.docs[0].data().testName;

            resultsSnapshot.forEach((doc, index) => {
                const result = doc.data();
                const rank = index + 1;

                const li = document.createElement('li');
                li.className = 'list-item';

                let rankDisplay;
                if (rank === 1) {
                    rankDisplay = '<span class="medal">ðŸ¥‡</span>';
                    li.classList.add('gold');
                } else if (rank === 2) {
                    rankDisplay = '<span class="medal">ðŸ¥ˆ</span>';
                    li.classList.add('silver');
                } else if (rank === 3) {
                    rankDisplay = '<span class="medal">ðŸ¥‰</span>';
                    li.classList.add('bronze');
                } else {
                    rankDisplay = rank;
                }

                if (result.userId === currentUserId) {
                    li.classList.add('user-highlight');
                }
                
                li.innerHTML = `
                    <div class="rank">${rankDisplay}</div>
                    <div class="name">${result.studentName}</div>
                    <div class="score">${result.score}</div>
                `;
                leaderboardList.appendChild(li);
            });

        } catch (error) {
            console.error("Error loading leaderboard: ", error);
            document.getElementById('loading').textContent = 'Could not load leaderboard.';
        }
    }

    document.addEventListener('DOMContentLoaded', loadLeaderboard);
</script>

</body>
</html>
